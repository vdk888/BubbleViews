# Database Migrations Runbook

## Overview

This document describes the database migration workflow for the Reddit AI Agent using Alembic and SQLAlchemy. Our migration system supports SQLite (MVP) with PostgreSQL compatibility for future upgrades.

## Technology Stack

- **ORM**: SQLAlchemy 2.0+ with async support
- **Migration Tool**: Alembic 1.13+
- **Database**: SQLite with aiosqlite driver (PostgreSQL-ready schema)
- **Python**: 3.10+

## Directory Structure

```
backend/
├── alembic/
│   ├── versions/          # Migration scripts
│   ├── env.py            # Migration environment configuration
│   └── script.py.mako    # Migration template
├── alembic.ini           # Alembic configuration
├── app/
│   └── models/           # SQLAlchemy ORM models
│       ├── base.py       # Base classes and mixins
│       ├── persona.py    # Persona model
│       ├── belief.py     # Belief graph models
│       ├── interaction.py # Episodic memory
│       ├── pending_post.py # Moderation queue
│       └── agent_config.py # Configuration
└── data/
    └── reddit_agent.db   # SQLite database file
```

## Common Migration Operations

### Creating a New Migration

When you add or modify ORM models, create a migration:

```bash
cd backend

# Autogenerate migration based on model changes
alembic revision --autogenerate -m "Description of changes"

# Example: Adding a new column
alembic revision --autogenerate -m "Add email column to personas"
```

**Best Practices**:
- Use descriptive migration messages
- Review autogenerated migrations before applying
- Test migrations before committing
- Keep migrations atomic (one logical change per migration)

### Applying Migrations

```bash
# Apply all pending migrations
alembic upgrade head

# Apply specific number of migrations
alembic upgrade +2

# Apply to specific revision
alembic upgrade <revision_id>
```

### Rolling Back Migrations

```bash
# Roll back one migration
alembic downgrade -1

# Roll back to specific revision
alembic downgrade <revision_id>

# Roll back all migrations
alembic downgrade base
```

### Viewing Migration Status

```bash
# Show current revision
alembic current

# Show migration history
alembic history

# Show pending migrations
alembic history --verbose
```

## Migration Workflow

### 1. Development Phase

1. **Modify Models**: Update SQLAlchemy models in `app/models/`
2. **Generate Migration**: `alembic revision --autogenerate -m "description"`
3. **Review Migration**: Check generated migration in `alembic/versions/`
4. **Test Locally**: Apply migration and test functionality
5. **Commit**: Add migration file to version control

### 2. Review and Validation

Before merging migration PRs:

```bash
# Test upgrade
alembic upgrade head

# Test downgrade
alembic downgrade -1

# Test upgrade again
alembic upgrade head

# Run database tests
python tests/test_database_simple.py
```

### 3. Deployment

```bash
# On production server
cd /path/to/backend

# Backup database (IMPORTANT!)
cp data/reddit_agent.db data/reddit_agent.db.backup.$(date +%Y%m%d_%H%M%S)

# Apply migrations
alembic upgrade head

# Verify
alembic current
```

## Handling Common Scenarios

### Adding a New Table

1. Create the SQLAlchemy model in `app/models/`
2. Import model in `app/models/__init__.py`
3. Generate migration: `alembic revision --autogenerate -m "Add new_table"`
4. Review and apply

### Adding a Column

1. Add column to model
2. Generate migration: `alembic revision --autogenerate -m "Add column_name to table_name"`
3. **Important**: For non-nullable columns, provide default value or migration will fail

```python
# Example: Adding non-nullable column with default
op.add_column('personas',
    sa.Column('is_active', sa.Boolean(), nullable=False, server_default='1')
)
```

### Renaming a Column

Alembic may detect this as drop+add. Manually edit migration:

```python
def upgrade():
    op.alter_column('personas', 'old_name', new_column_name='new_name')

def downgrade():
    op.alter_column('personas', 'new_name', new_column_name='old_name')
```

### Data Migrations

For migrations that require data transformation:

```python
from alembic import op
from sqlalchemy import text

def upgrade():
    # Add column
    op.add_column('personas', sa.Column('full_name', sa.String()))

    # Migrate data
    conn = op.get_bind()
    conn.execute(
        text("UPDATE personas SET full_name = display_name WHERE display_name IS NOT NULL")
    )

def downgrade():
    op.drop_column('personas', 'full_name')
```

### Handling Foreign Keys (SQLite)

SQLite has limited ALTER TABLE support. Use batch operations:

```python
def upgrade():
    with op.batch_alter_table('belief_nodes', schema=None) as batch_op:
        batch_op.add_column(sa.Column('category_id', sa.String(), nullable=True))
        batch_op.create_foreign_key(
            'fk_belief_category',
            'categories',
            ['category_id'],
            ['id']
        )
```

## Migration Best Practices

### Forward-Only Migrations

Design migrations to be applied sequentially:
- Each migration should be independent
- Avoid dependencies on future migrations
- Test downgrade paths but prefer forward-only in production

### Testing

Always test migrations:

```bash
# Create test database
cp data/reddit_agent.db data/test_reddit_agent.db

# Test on test database
SQLALCHEMY_URL=sqlite+aiosqlite:///./data/test_reddit_agent.db alembic upgrade head

# Clean up
rm data/test_reddit_agent.db*
```

### Database Backups

**Before any migration**:

```bash
# Automated backup
cp data/reddit_agent.db "data/backups/reddit_agent_$(date +%Y%m%d_%H%M%S).db"

# Verify backup
ls -lh data/backups/
```

### Migration File Naming

Alembic generates names like: `<revision>_<slug>.py`
- Keep slugs short and descriptive
- Example: `abc123_add_email_to_personas.py`

## Troubleshooting

### Migration Fails Mid-Way

```bash
# Check current state
alembic current

# If migration is partially applied, manual intervention may be needed
# 1. Backup database
# 2. Restore from backup
# 3. Fix migration script
# 4. Retry
```

### Conflicts Between Branches

If two branches create migrations simultaneously:

```bash
# Check for multiple heads
alembic heads

# Merge heads (create merge migration)
alembic merge -m "Merge migrations" <rev1> <rev2>
```

### SQLite Locking

If you see "database is locked":
- Ensure no other processes are using the database
- Check for orphaned WAL files
- Restart the application

### Downgrade Not Working

Some operations can't be automatically reversed:
- Data deletions
- Complex schema changes

Always test downgrades in development.

## PostgreSQL Migration Path

When migrating from SQLite to PostgreSQL:

1. **Export Data**: Use SQLAlchemy to read all data
2. **Update Configuration**: Change `sqlalchemy.url` in `alembic.ini`
3. **Run Migrations**: `alembic upgrade head` on PostgreSQL
4. **Import Data**: Use SQLAlchemy to write data to PostgreSQL
5. **Verify**: Run tests and compare schemas

Schema is designed for PostgreSQL compatibility:
- TEXT columns for datetime (ISO format)
- TEXT columns for UUIDs (string format)
- Proper foreign key constraints
- JSON columns (PostgreSQL has native JSONB)

## Configuration

### alembic.ini

```ini
[alembic]
script_location = %(here)s/alembic
sqlalchemy.url = sqlite+aiosqlite:///./data/reddit_agent.db
```

### env.py

Configured for async SQLite with:
- Async engine support
- Model metadata import
- Batch operations for SQLite

## Reference

### Alembic Commands

```bash
# Migration generation
alembic revision --autogenerate -m "message"
alembic revision -m "message"  # Manual migration

# Migration application
alembic upgrade head
alembic upgrade +1
alembic downgrade -1
alembic downgrade base

# Information
alembic current
alembic history
alembic heads
alembic show <revision>

# Merging
alembic merge <rev1> <rev2>
```

### SQLAlchemy Model Changes Requiring Migrations

- Adding/removing tables
- Adding/removing columns
- Modifying column types
- Adding/removing constraints
- Adding/removing indexes
- Renaming tables/columns

### Schema Inspection

```bash
# Using sqlite3 CLI
sqlite3 data/reddit_agent.db

# List tables
.tables

# Show schema
.schema personas

# Check WAL mode
PRAGMA journal_mode;

# Enable WAL mode
PRAGMA journal_mode=WAL;
```

## Emergency Procedures

### Complete Migration Failure

```bash
# 1. Stop application
# 2. Restore from backup
cp data/backups/reddit_agent_YYYYMMDD_HHMMSS.db data/reddit_agent.db

# 3. Verify restoration
alembic current

# 4. Investigate and fix
# 5. Test migration on copy
# 6. Retry
```

### Database Corruption

```bash
# Check integrity
sqlite3 data/reddit_agent.db "PRAGMA integrity_check;"

# If corrupted, restore from backup
# Then investigate root cause
```

## Additional Resources

- [Alembic Documentation](https://alembic.sqlalchemy.org/)
- [SQLAlchemy Documentation](https://docs.sqlalchemy.org/)
- [SQLite Documentation](https://sqlite.org/docs.html)

## Maintenance

### Regular Tasks

- **Weekly**: Review migration history for cruft
- **Monthly**: Test backup/restore procedures
- **Quarterly**: Review and cleanup old backups

### Health Checks

```bash
# Check database file size
ls -lh data/reddit_agent.db

# Check WAL file size
ls -lh data/reddit_agent.db-wal

# Checkpoint WAL (merge back to main DB)
sqlite3 data/reddit_agent.db "PRAGMA wal_checkpoint(TRUNCATE);"
```

---

**Last Updated**: 2025-11-24
**Version**: 1.0
**Maintainer**: Reddit AI Agent Team
